/**
 * Test script for CashNDrive API with GPT-4o integration
 */

const config = require('./config');

async function testAPI() {
  console.log('\nğŸ§ª Testing CashNDrive API with GPT-4o\n');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  const API_BASE = 'http://localhost:7071/api';

  // Test 1: Health Check
  console.log('1ï¸âƒ£  Testing Health Check...');
  try {
    const response = await fetch(`${API_BASE}/health`);
    const data = await response.json();
    console.log('   âœ… Health:', data.status);
  } catch (error) {
    console.log('   âŒ Health check failed:', error.message);
  }
  console.log('');

  // Test 2: AI Response (Simple greeting)
  console.log('2ï¸âƒ£  Testing AI Response - Greeting...');
  try {
    const response = await fetch(`${API_BASE}/GetAIResponse`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userMessage: 'DobrÃ½ den, chtÄ›l bych informace o vaÅ¡ich sluÅ¾bÃ¡ch.'
      })
    });
    const data = await response.json();
    console.log('   User: DobrÃ½ den, chtÄ›l bych informace o vaÅ¡ich sluÅ¾bÃ¡ch.');
    console.log('   AI: ' + data.response);
    console.log('   âœ… Response received');
  } catch (error) {
    console.log('   âŒ AI Response failed:', error.message);
  }
  console.log('');

  // Test 3: AI Response with conversation history
  console.log('3ï¸âƒ£  Testing AI Response - With History...');
  try {
    const response = await fetch(`${API_BASE}/GetAIResponse`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userMessage: 'JakÃ© jsou ceny?',
        conversationHistory: [
          { type: 'user', text: 'DobrÃ½ den' },
          { type: 'ai', text: 'DobrÃ½ den, jsem AI asistent CashNDrive.' },
          { type: 'user', text: 'ZajÃ­mÃ¡ mÄ› vaÅ¡e sluÅ¾ba' },
          { type: 'ai', text: 'RÃ¡di vÃ¡m poskytneme informace o naÅ¡ich AI hlasovÃ½ch sluÅ¾bÃ¡ch.' }
        ]
      })
    });
    const data = await response.json();
    console.log('   User: JakÃ© jsou ceny?');
    console.log('   AI: ' + data.response);
    console.log('   âœ… Context-aware response received');
  } catch (error) {
    console.log('   âŒ Context test failed:', error.message);
  }
  console.log('');

  // Test 4: Generate Summary
  console.log('4ï¸âƒ£  Testing Summary Generation...');
  try {
    const response = await fetch(`${API_BASE}/GenerateSummary`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: [
          { type: 'user', text: 'DobrÃ½ den, potÅ™ebuji pomoc s nastavenÃ­m AI asistenta.' },
          { type: 'ai', text: 'DobrÃ½ den! RÃ¡d vÃ¡m pomohu. Co konkrÃ©tnÄ› potÅ™ebujete nastavit?' },
          { type: 'user', text: 'Chci, aby asistent umÄ›l mluvit Äesky a odpovÃ­dat na dotazy o cenÃ¡ch.' },
          { type: 'ai', text: 'RozumÃ­m. NÃ¡Å¡ systÃ©m podporuje ÄeÅ¡tinu nativnÄ› a mÅ¯Å¾eme nastavit automatickÃ© odpovÄ›di na cenovÃ© dotazy.' },
          { type: 'user', text: 'Kolik to bude stÃ¡t?' },
          { type: 'ai', text: 'ZÃ¡kladnÃ­ balÃ­Äek zaÄÃ­nÃ¡ na 5000 KÄ mÄ›sÃ­ÄnÄ›. Zahrnuje 1000 minut hovorÅ¯ a podporu 24/7.' },
          { type: 'user', text: 'To znÃ­ dobÅ™e. MÅ¯Å¾ete mi poslat nabÃ­dku na email?' },
          { type: 'ai', text: 'SamozÅ™ejmÄ›! Na jakÃ½ email vÃ¡m mÃ¡m nabÃ­dku zaslat?' }
        ],
        duration: 180
      })
    });
    const data = await response.json();
    console.log('   Summary generated:');
    console.log('   - Reason:', data.reason);
    console.log('   - Sentiment:', data.sentiment);
    console.log('   - Follow-up:', data.followUp);
    console.log('   - Generated by:', data.generatedBy || 'Rule-based');
    if (data.keyPoints) {
      console.log('   - Key Points:');
      data.keyPoints.forEach(point => console.log('     â€¢', point));
    }
    console.log('   âœ… Summary generated successfully');
  } catch (error) {
    console.log('   âŒ Summary generation failed:', error.message);
  }
  console.log('');

  // Configuration summary
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ğŸ“‹ Configuration Status:');
  console.log('   Endpoint:', config.AZURE_AI_ENDPOINT || 'âŒ Not set');
  console.log('   API Key:', config.AZURE_AI_KEY ? 'âœ… Configured' : 'âŒ Not set');
  console.log('   Deployment:', config.AZURE_AI_DEPLOYMENT_NAME || 'âŒ Not set');
  console.log('   Speech Region:', config.AZURE_SPEECH_REGION || 'âŒ Not set');
  console.log('');
  console.log('ğŸ‰ API Testing Complete!\n');
}

// Run tests
testAPI().catch(console.error);
